# --- Step 1: Import Libraries ---
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from datetime import datetime
import seaborn as sns

# --- Step 2: Load Dataset ---
# (You can replace the file path with your dataset, e.g. "OnlineRetail.xlsx")
data = pd.read_excel("OnlineRetail.xlsx")
print("Dataset loaded successfully!")
print(data.head())

# --- Step 3: Data Cleaning ---
# Remove missing Customer IDs
data = data[data['CustomerID'].notnull()]

# Remove cancelled transactions (InvoiceNo starting with 'C')
data = data[~data['InvoiceNo'].astype(str).str.startswith('C')]

# Add Total Amount column
data['TotalAmount'] = data['Quantity'] * data['UnitPrice']

# --- Step 4: RFM Calculation ---
# Define latest date for Recency calculation
latest_date = data['InvoiceDate'].max() + pd.DateOffset(days=1)

# Calculate R, F, M values
rfm = data.groupby('CustomerID').agg({
    'InvoiceDate': lambda x: (latest_date - x.max()).days,   # Recency
    'InvoiceNo': 'nunique',                                 # Frequency
    'TotalAmount': 'sum'                                    # Monetary
})

# Rename columns
rfm.columns = ['Recency', 'Frequency', 'Monetary']

# --- Step 5: RFM Scoring ---
rfm['R_rank'] = pd.qcut(rfm['Recency'], 4, labels=[4,3,2,1])
rfm['F_rank'] = pd.qcut(rfm['Frequency'].rank(method='first'), 4, labels=[1,2,3,4])
rfm['M_rank'] = pd.qcut(rfm['Monetary'], 4, labels=[1,2,3,4])

rfm['RFM_Score'] = rfm['R_rank'].astype(str) + rfm['F_rank'].astype(str) + rfm['M_rank'].astype(str)

# --- Step 6: Define Customer Segments ---
def segment_customer(score):
    if score == '444':
        return 'Top Customers'
    elif score[0] == '4':
        return 'Loyal Customers'
    elif score[1] == '4':
        return 'Frequent Buyers'
    elif score[2] == '4':
        return 'Big Spenders'
    elif score[0] == '1':
        return 'Lost Customers'
    else:
        return 'Regular Customers'

rfm['Segment'] = rfm['RFM_Score'].apply(segment_customer)

# --- Step 7: Display Results ---
print("\n Sample RFM Table:")
print(rfm.head())

# --- Step 8: Visualization ---
plt.figure(figsize=(10,6))
sns.countplot(data=rfm, x='Segment', order=rfm['Segment'].value_counts().index)
plt.title('Customer Segments based on RFM')
plt.xlabel('Segment')
plt.ylabel('Number of Customers')
plt.xticks(rotation=30)
plt.show()

# --- Step 9: Save Result ---
rfm.to_csv("RFM_Customer_Segmentation.csv")
print("\n RFM segmentation saved to 'RFM_Customer_Segmentation.csv'")
